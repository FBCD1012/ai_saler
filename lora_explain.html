<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRAå¾®è°ƒåŸç†</title>
    <link rel="stylesheet" href="styles/common.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* é¡µé¢ç‰¹æœ‰æ ·å¼ */
        h1 span { color: #f0f; }
        #lora-svg { height: 300px; }
        #flow-svg { height: 200px; }
        /* è¦†ç›– note é¢œè‰²ä¸ºç´«è‰² */
        .note {
            background: rgba(255,0,255,0.08);
            border-left-color: #f0f;
        }
        .note strong { color: #f0f; }
    </style>
</head>
<body>
    <div class="page">
        <h1>LoRA <span>å¾®è°ƒåŸç†</span></h1>
        <p class="subtitle">Low-Rank Adaptation Â· ä½ç§©é€‚é… Â· ç”¨å°å‚æ•°æ’¬åŠ¨å¤§æ¨¡å‹</p>

        <!-- å¯¹æ¯” -->
        <div class="compare">
            <div class="compare-box bad">
                <h3><span class="dot" style="background:#f55"></span>å…¨é‡å¾®è°ƒï¼ˆä¸æ¨èï¼‰</h3>
                <ul>
                    <li>âŒ è®­ç»ƒå…¨éƒ¨70äº¿å‚æ•°</li>
                    <li>âŒ éœ€è¦80GB+ æ˜¾å­˜</li>
                    <li>âŒ è®­ç»ƒå‡ å¤©åˆ°å‡ å‘¨</li>
                    <li>âŒ å®¹æ˜“è¿‡æ‹Ÿåˆ</li>
                </ul>
            </div>
            <div class="compare-box good">
                <h3><span class="dot" style="background:#0f0"></span>LoRAå¾®è°ƒï¼ˆæ¨èï¼‰</h3>
                <ul>
                    <li>âœ“ åªè®­ç»ƒ0.1%å‚æ•°ï¼ˆçº¦700ä¸‡ï¼‰</li>
                    <li>âœ“ 8GBæ˜¾å­˜å°±å¤Ÿ</li>
                    <li>âœ“ å‡ å°æ—¶å®Œæˆ</li>
                    <li>âœ“ ä½ çš„Macèƒ½è·‘</li>
                </ul>
            </div>
        </div>

        <!-- LoRAåŸç†å›¾ -->
        <div class="card">
            <div class="card-title">LoRA æ ¸å¿ƒåŸç†</div>
            <svg id="lora-svg"></svg>
            <div class="note">
                <strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong>å†»ç»“åŸæ¨¡å‹ï¼ˆè“è‰²ï¼‰ï¼Œåªè®­ç»ƒä¸¤ä¸ªå°çŸ©é˜µAå’ŒBï¼ˆç»¿è‰²ï¼‰ã€‚
                æœ€ç»ˆæ•ˆæœ = åŸæ¨¡å‹ + AÃ—B
            </div>
        </div>

        <!-- æµç¨‹å›¾ -->
        <div class="card">
            <div class="card-title">å¾®è°ƒæµç¨‹</div>
            <svg id="flow-svg"></svg>
        </div>

        <!-- æ­¥éª¤ -->
        <div class="card">
            <div class="card-title">åœ¨ä½ çš„Macä¸Šæ“ä½œæ­¥éª¤</div>
            <div class="steps">
                <div class="step">
                    <div class="step-num">1</div>
                    <div class="step-title">å‡†å¤‡æ•°æ®</div>
                    <div class="step-desc">æ•´ç†é—®ç­”å¯¹</div>
                </div>
                <div class="step">
                    <div class="step-num">2</div>
                    <div class="step-title">å®‰è£…MLX</div>
                    <div class="step-desc">Appleå®˜æ–¹æ¡†æ¶</div>
                </div>
                <div class="step">
                    <div class="step-num">3</div>
                    <div class="step-title">ä¸‹è½½åŸºåº§</div>
                    <div class="step-desc">Qwen2.5-7B</div>
                </div>
                <div class="step">
                    <div class="step-num">4</div>
                    <div class="step-title">å¼€å§‹è®­ç»ƒ</div>
                    <div class="step-desc">ä¸€è¡Œå‘½ä»¤</div>
                </div>
            </div>

            <!-- æ•°æ®æ ¼å¼ -->
            <div class="data-example">
                <strong style="color:#fff">è®­ç»ƒæ•°æ®æ ¼å¼ï¼ˆJSONLï¼‰ï¼š</strong>
                <pre>
{<span class="key">"instruction"</span>: <span class="value">"å®¢æˆ·é—®ä¸ºä»€ä¹ˆæ¶¨ä»·äº†"</span>, <span class="key">"output"</span>: <span class="value">"æ‚¨å¥½ï¼Œè¿‘æœŸåŸææ–™æˆæœ¬ä¸Šæ¶¨15%..."</span>}
{<span class="key">"instruction"</span>: <span class="value">"å®¢æˆ·è¯´å¤ªè´µäº†"</span>, <span class="key">"output"</span>: <span class="value">"ç†è§£æ‚¨çš„é¡¾è™‘ï¼Œæˆ‘ä»¬çš„äº§å“..."</span>}
{<span class="key">"instruction"</span>: <span class="value">"å®¢æˆ·è¦æ±‚é€€è´§"</span>, <span class="key">"output"</span>: <span class="value">"å¥½çš„ï¼Œ7å¤©æ— ç†ç”±é€€è´§..."</span>}</pre>
            </div>

            <!-- å‘½ä»¤ -->
            <div class="code-block">
<span class="comment"># 1. å®‰è£…MLX-LM</span>
<span class="cmd">pip install mlx-lm</span>

<span class="comment"># 2. ä¸‹è½½åŸºåº§æ¨¡å‹</span>
<span class="cmd">huggingface-cli download Qwen/Qwen2.5-7B-Instruct --local-dir ./qwen</span>

<span class="comment"># 3. å¼€å§‹LoRAå¾®è°ƒ</span>
<span class="cmd">mlx_lm.lora --model ./qwen --data ./train_data.jsonl --iters 100</span>

<span class="comment"># 4. åˆå¹¶æƒé‡</span>
<span class="cmd">mlx_lm.fuse --model ./qwen --adapter-path ./adapters</span>
            </div>
        </div>

        <!-- éœ€è¦å¤šå°‘æ•°æ® -->
        <div class="card">
            <div class="card-title">éœ€è¦å‡†å¤‡å¤šå°‘æ•°æ®ï¼Ÿ</div>
            <div class="compare">
                <div class="compare-box">
                    <h3>æœ€å°‘</h3>
                    <ul>
                        <li>50-100æ¡é«˜è´¨é‡é—®ç­”</li>
                        <li>èƒ½è·‘èµ·æ¥ï¼Œæ•ˆæœä¸€èˆ¬</li>
                    </ul>
                </div>
                <div class="compare-box good">
                    <h3>æ¨è</h3>
                    <ul>
                        <li>500-1000æ¡é—®ç­”</li>
                        <li>æ•ˆæœæ˜æ˜¾ï¼Œé£æ ¼ç»Ÿä¸€</li>
                    </ul>
                </div>
            </div>
            <div class="note">
                <strong>æç¤ºï¼š</strong>æ•°æ®è´¨é‡æ¯”æ•°é‡é‡è¦ã€‚100æ¡ç²¾å¿ƒå‡†å¤‡çš„æ•°æ® > 1000æ¡éšä¾¿å†™çš„æ•°æ®ã€‚
            </div>
        </div>
    </div>

    <script>
        // ========== LoRAåŸç†å›¾ ==========
        const loraSvg = d3.select("#lora-svg");
        const W = loraSvg.node().getBoundingClientRect().width;
        const H = 300;
        loraSvg.attr("viewBox", `0 0 ${W} ${H}`);

        const centerY = H / 2;

        // åŸå§‹æƒé‡çŸ©é˜µ W (å†»ç»“)
        loraSvg.append("rect")
            .attr("x", W * 0.1)
            .attr("y", centerY - 80)
            .attr("width", 120)
            .attr("height", 160)
            .attr("rx", 8)
            .attr("fill", "#1a3a5c")
            .attr("stroke", "#0af")
            .attr("stroke-width", 2);

        loraSvg.append("text")
            .attr("x", W * 0.1 + 60)
            .attr("y", centerY)
            .attr("text-anchor", "middle")
            .attr("fill", "#0af")
            .attr("font-size", "18px")
            .attr("font-weight", "600")
            .text("W");

        loraSvg.append("text")
            .attr("x", W * 0.1 + 60)
            .attr("y", centerY + 25)
            .attr("text-anchor", "middle")
            .attr("fill", "#666")
            .attr("font-size", "11px")
            .text("åŸæ¨¡å‹æƒé‡");

        loraSvg.append("text")
            .attr("x", W * 0.1 + 60)
            .attr("y", centerY + 40)
            .attr("text-anchor", "middle")
            .attr("fill", "#f55")
            .attr("font-size", "10px")
            .text("ğŸ”’ å†»ç»“");

        // åŠ å·
        loraSvg.append("text")
            .attr("x", W * 0.32)
            .attr("y", centerY + 8)
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("font-size", "28px")
            .text("+");

        // LoRAçŸ©é˜µ A (å°)
        loraSvg.append("rect")
            .attr("x", W * 0.4)
            .attr("y", centerY - 80)
            .attr("width", 30)
            .attr("height", 160)
            .attr("rx", 4)
            .attr("fill", "#1a4a2c")
            .attr("stroke", "#0f0")
            .attr("stroke-width", 2);

        loraSvg.append("text")
            .attr("x", W * 0.4 + 15)
            .attr("y", centerY)
            .attr("text-anchor", "middle")
            .attr("fill", "#0f0")
            .attr("font-size", "14px")
            .attr("font-weight", "600")
            .text("A");

        // ä¹˜å·
        loraSvg.append("text")
            .attr("x", W * 0.47)
            .attr("y", centerY + 8)
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("font-size", "20px")
            .text("Ã—");

        // LoRAçŸ©é˜µ B (å°)
        loraSvg.append("rect")
            .attr("x", W * 0.52)
            .attr("y", centerY - 15)
            .attr("width", 120)
            .attr("height", 30)
            .attr("rx", 4)
            .attr("fill", "#1a4a2c")
            .attr("stroke", "#0f0")
            .attr("stroke-width", 2);

        loraSvg.append("text")
            .attr("x", W * 0.52 + 60)
            .attr("y", centerY + 5)
            .attr("text-anchor", "middle")
            .attr("fill", "#0f0")
            .attr("font-size", "14px")
            .attr("font-weight", "600")
            .text("B");

        // LoRAæ ‡ç­¾
        loraSvg.append("text")
            .attr("x", W * 0.52)
            .attr("y", centerY + 55)
            .attr("fill", "#0f0")
            .attr("font-size", "11px")
            .text("LoRAé€‚é…å™¨");

        loraSvg.append("text")
            .attr("x", W * 0.52)
            .attr("y", centerY + 70)
            .attr("fill", "#666")
            .attr("font-size", "10px")
            .text("âœ“ å¯è®­ç»ƒï¼Œå‚æ•°å¾ˆå°‘");

        // ç­‰å·
        loraSvg.append("text")
            .attr("x", W * 0.72)
            .attr("y", centerY + 8)
            .attr("text-anchor", "middle")
            .attr("fill", "#fff")
            .attr("font-size", "28px")
            .text("=");

        // æœ€ç»ˆç»“æœ
        loraSvg.append("rect")
            .attr("x", W * 0.78)
            .attr("y", centerY - 80)
            .attr("width", 120)
            .attr("height", 160)
            .attr("rx", 8)
            .attr("fill", "#3a2a4c")
            .attr("stroke", "#f0f")
            .attr("stroke-width", 2);

        loraSvg.append("text")
            .attr("x", W * 0.78 + 60)
            .attr("y", centerY)
            .attr("text-anchor", "middle")
            .attr("fill", "#f0f")
            .attr("font-size", "18px")
            .attr("font-weight", "600")
            .text("W'");

        loraSvg.append("text")
            .attr("x", W * 0.78 + 60)
            .attr("y", centerY + 25)
            .attr("text-anchor", "middle")
            .attr("fill", "#666")
            .attr("font-size", "11px")
            .text("ä½ çš„ä¸“å±æ¨¡å‹");

        // ========== æµç¨‹å›¾ ==========
        const flowSvg = d3.select("#flow-svg");
        const flowW = flowSvg.node().getBoundingClientRect().width;
        const flowH = 200;
        flowSvg.attr("viewBox", `0 0 ${flowW} ${flowH}`);

        const flowNodes = [
            { x: 0.1, label: "ä½ çš„æ•°æ®", sub: "é—®ç­”å¯¹", color: "#fa0" },
            { x: 0.3, label: "åŸºåº§æ¨¡å‹", sub: "Qwen2.5", color: "#0af" },
            { x: 0.5, label: "LoRAè®­ç»ƒ", sub: "å‡ å°æ—¶", color: "#0f0" },
            { x: 0.7, label: "åˆå¹¶æƒé‡", sub: "fuse", color: "#f0f" },
            { x: 0.9, label: "ä¸“å±æ¨¡å‹", sub: "å¯éƒ¨ç½²", color: "#f0f" },
        ];

        const flowY = flowH / 2;

        // è¿çº¿
        flowNodes.slice(0, -1).forEach((node, i) => {
            const next = flowNodes[i + 1];
            flowSvg.append("line")
                .attr("x1", node.x * flowW + 50)
                .attr("y1", flowY)
                .attr("x2", next.x * flowW - 50)
                .attr("y2", flowY)
                .attr("stroke", "#333")
                .attr("stroke-width", 3);

            flowSvg.append("polygon")
                .attr("points", "-8,-6 0,0 -8,6")
                .attr("fill", "#555")
                .attr("transform", `translate(${next.x * flowW - 45}, ${flowY})`);
        });

        // èŠ‚ç‚¹
        flowNodes.forEach(node => {
            const x = node.x * flowW;
            const g = flowSvg.append("g").attr("transform", `translate(${x}, ${flowY})`);

            g.append("circle")
                .attr("r", 35)
                .attr("fill", "#0a0a0a")
                .attr("stroke", node.color)
                .attr("stroke-width", 2);

            g.append("text")
                .attr("y", -5)
                .attr("text-anchor", "middle")
                .attr("fill", "#fff")
                .attr("font-size", "11px")
                .text(node.label);

            g.append("text")
                .attr("y", 12)
                .attr("text-anchor", "middle")
                .attr("fill", "#666")
                .attr("font-size", "9px")
                .text(node.sub);
        });
    </script>
</body>
</html>
